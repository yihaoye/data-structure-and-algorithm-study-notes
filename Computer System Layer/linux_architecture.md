# Linux 系统完整架构图

```
═══════════════════════════════════════════════════════════════════════════════
                            USER SPACE (Ring 3)
                           用户空间 - 非特权模式
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                          USER APPLICATIONS                                  │
│                           用户应用程序层                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐         │
│  │  Web Servers     │  │   Databases      │  │   Your Apps      │         │
│  │  • nginx         │  │   • PostgreSQL   │  │   • API services │         │
│  │  • Apache        │  │   • MySQL        │  │   • Microservices│         │
│  │  • Caddy         │  │   • MongoDB      │  │   • CLI tools    │         │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘         │
│                                                                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐         │
│  │  System Services │  │   GUI Apps       │  │   Shells         │         │
│  │  • systemd       │  │   • Firefox      │  │   • bash         │         │
│  │  • dockerd       │  │   • VS Code      │  │   • zsh          │         │
│  │  • sshd          │  │   • Terminal     │  │   • fish         │         │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘         │
│                                                                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐         │
│  │  System Tools    │  │   Init System    │  │   Compilers      │         │
│  │  • ls, cat, grep │  │   • /sbin/init   │  │   • gcc          │         │
│  │  • curl, wget    │  │   • PID 1        │  │   • rustc        │         │
│  │  • vim, nano     │  │                  │  │   • go           │         │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 函数调用
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      STANDARD LIBRARIES & RUNTIMES                          │
│                        标准库和运行时环境层                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────┐        │
│  │             C/C++ Programs 的路径                              │        │
│  │                                                                │        │
│  │    Your C Code                                                 │        │
│  │         │                                                      │        │
│  │         ▼                                                      │        │
│  │    ┌────────────────────────────────────────────────┐        │        │
│  │    │  glibc (GNU C Library)                         │        │        │
│  │    │  • printf(), scanf()                           │        │        │
│  │    │  • malloc(), free()                            │        │        │
│  │    │  • open(), read(), write() ← 系统调用包装      │        │        │
│  │    │  • pthread_create() ← 线程库                   │        │        │
│  │    │  • socket(), connect() ← 网络函数              │        │        │
│  │    └────────────────────┬───────────────────────────┘        │        │
│  │                         │                                     │        │
│  └─────────────────────────┼─────────────────────────────────────┘        │
│                            │                                              │
│  ┌────────────────────────┼──────────────────────────────────────┐        │
│  │             Python 的路径│                                     │        │
│  │                         │                                     │        │
│  │    Your Python Code     │                                     │        │
│  │         │               │                                     │        │
│  │         ▼               │                                     │        │
│  │    ┌──────────────┐    │                                     │        │
│  │    │   CPython    │    │                                     │        │
│  │    │  Interpreter │────┘ (CPython 本身链接 glibc)            │        │
│  │    └──────────────┘                                          │        │
│  └──────────────────────────────────────────────────────────────┘        │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────┐        │
│  │             Java 的路径                                       │        │
│  │                                                               │        │
│  │    Your Java Code                                             │        │
│  │         │                                                     │        │
│  │         ▼                                                     │        │
│  │    ┌──────────────┐                                          │        │
│  │    │     JVM      │───→ (JVM 本身链接 glibc)                 │        │
│  │    │  (HotSpot)   │                                          │        │
│  │    └──────────────┘                                          │        │
│  └──────────────────────────────────────────────────────────────┘        │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────┐        │
│  │             Go 的路径 (特殊！)                                │        │
│  │                                                               │        │
│  │    Your Go Code                                               │        │
│  │         │                                                     │        │
│  │         ▼                                                     │        │
│  │    ┌───────────────────────────────────────┐                 │        │
│  │    │  Go Runtime (内置在二进制中)          │                 │        │
│  │    │  • syscall 包                         │                 │        │
│  │    │  • 直接系统调用 (不经过 glibc!)       │                 │        │
│  │    │  • 内置调度器 (goroutine)             │                 │        │
│  │    │  • 内置 GC                            │                 │        │
│  │    └───────────────────────────────────────┘                 │        │
│  │         │                                                     │        │
│  │         │ (如果使用 Cgo)                                      │        │
│  │         └──→ glibc                                            │        │
│  └──────────────────────────────────────────────────────────────┘        │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────┐        │
│  │             Rust 的路径                                       │        │
│  │                                                               │        │
│  │    Your Rust Code                                             │        │
│  │         │                                                     │        │
│  │         ▼                                                     │        │
│  │    ┌──────────────┐                                          │        │
│  │    │  std / libc  │───→ glibc (默认)                         │        │
│  │    │   crate      │    或 musl (静态链接)                    │        │
│  │    └──────────────┘                                          │        │
│  └──────────────────────────────────────────────────────────────┘        │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────┐        │
│  │             Other Libraries 其他库                            │        │
│  │  • libpthread (POSIX 线程库)                                  │        │
│  │  • libm (数学库)                                              │        │
│  │  • libssl / libcrypto (OpenSSL)                               │        │
│  │  • libcurl (HTTP 客户端)                                      │        │
│  │  • libz (压缩库)                                              │        │
│  │  • ... (成千上万的 .so 共享库)                                │        │
│  └──────────────────────────────────────────────────────────────┘        │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                      多种路径汇聚到系统调用接口
                                    │
═══════════════════════════════════════════════════════════════════════════════
                    USER/KERNEL BOUNDARY - 用户态/内核态边界
        通过 SYSCALL 指令 (x86-64) 或 INT 0x80 (x86) 进入内核
        上下文切换：Ring 3 → Ring 0，保存/恢复寄存器，切换堆栈
═══════════════════════════════════════════════════════════════════════════════
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       SYSTEM CALL INTERFACE                                 │
│                          系统调用接口层                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  系统调用表 (约 300+ 个系统调用)                                             │
│                                                                             │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐│
│  │  File Operations    │  │  Process Management │  │  Memory Management  ││
│  │  • sys_open()       │  │  • sys_fork()       │  │  • sys_mmap()       ││
│  │  • sys_read()       │  │  • sys_execve()     │  │  • sys_brk()        ││
│  │  • sys_write()      │  │  • sys_clone()      │  │  • sys_mprotect()   ││
│  │  • sys_close()      │  │  • sys_wait4()      │  │  • sys_munmap()     ││
│  │  • sys_stat()       │  │  • sys_exit()       │  │  • sys_madvise()    ││
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘│
│                                                                             │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐│
│  │  Network Operations │  │  IPC Operations     │  │  Time/Signal        ││
│  │  • sys_socket()     │  │  • sys_pipe()       │  │  • sys_nanosleep()  ││
│  │  • sys_bind()       │  │  • sys_msgget()     │  │  • sys_gettime()    ││
│  │  • sys_connect()    │  │  • sys_semget()     │  │  • sys_kill()       ││
│  │  • sys_send()       │  │  • sys_shmget()     │  │  • sys_signal()     ││
│  │  • sys_recv()       │  │  • sys_mq_open()    │  │  • sys_alarm()      ││
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘│
│                                                                             │
│  每个系统调用都有对应的编号（syscall number）                                │
│  例如：sys_write = 1, sys_open = 2, sys_read = 0 (x86-64)                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
═══════════════════════════════════════════════════════════════════════════════
                          KERNEL SPACE (Ring 0)
                         内核空间 - 特权模式
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                           KERNEL CORE SERVICES                              │
│                            内核核心服务层                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           Process Management 进程管理                        │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  Scheduler 调度器                              │         │           │
│  │  │  • CFS (Completely Fair Scheduler)             │         │           │
│  │  │  • Real-time scheduler                         │         │           │
│  │  │  • Deadline scheduler                          │         │           │
│  │  │  • Load balancing (多核负载均衡)               │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  Process Operations                            │         │           │
│  │  │  • fork/clone (创建进程/线程)                   │         │           │
│  │  │  • exec (执行新程序)                            │         │           │
│  │  │  • exit (进程退出)                              │         │           │
│  │  │  • wait (等待子进程)                            │         │           │
│  │  │  • Context switch (上下文切换)                  │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           Memory Management 内存管理                         │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  Virtual Memory 虚拟内存                       │         │           │
│  │  │  • Page tables (页表管理)                      │         │           │
│  │  │  • MMU (Memory Management Unit) 控制           │         │           │
│  │  │  • Address space isolation (地址空间隔离)      │         │           │
│  │  │  • Copy-on-Write (写时复制)                    │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  Memory Allocation 内存分配                    │         │           │
│  │  │  • Buddy allocator (伙伴系统)                  │         │           │
│  │  │  • Slab allocator (对象缓存)                   │         │           │
│  │  │  • vmalloc (虚拟内存分配)                      │         │           │
│  │  │  • kmalloc (内核内存分配)                      │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  Paging & Swapping 分页与交换                  │         │           │
│  │  │  • Page cache (页缓存)                         │         │           │
│  │  │  • Swap management (交换空间管理)              │         │           │
│  │  │  • Page reclaim (页面回收)                     │         │           │
│  │  │  • OOM killer (内存不足处理)                   │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           File Systems 文件系统                              │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  VFS (Virtual File System) 虚拟文件系统        │         │           │
│  │  │  • 统一的文件系统接口                           │         │           │
│  │  │  • inode, dentry, file 对象管理                │         │           │
│  │  │  • Mount point 管理                            │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  Specific File Systems 具体文件系统             │         │           │
│  │  │  • ext4 (默认 Linux 文件系统)                  │         │           │
│  │  │  • xfs (高性能文件系统)                        │         │           │
│  │  │  • btrfs (写时复制文件系统)                    │         │           │
│  │  │  • tmpfs (内存文件系统)                        │         │           │
│  │  │  • procfs, sysfs (伪文件系统)                  │         │           │
│  │  │  • NFS, CIFS (网络文件系统)                    │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  Buffer Cache & Page Cache                     │         │           │
│  │  │  • 文件数据缓存                                 │         │           │
│  │  │  • Read-ahead (预读)                           │         │           │
│  │  │  • Write-back (延迟写)                         │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           Network Stack 网络协议栈                           │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  Socket Layer 套接字层                         │         │           │
│  │  │  • BSD socket API                              │         │           │
│  │  │  • Socket 缓冲区管理                            │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  Protocol Implementation 协议实现               │         │           │
│  │  │  • TCP (传输控制协议)                          │         │           │
│  │  │  • UDP (用户数据报协议)                        │         │           │
│  │  │  • IP (互联网协议 v4/v6)                       │         │           │
│  │  │  • ICMP (Internet 控制消息协议)                │         │           │
│  │  │  • ARP (地址解析协议)                          │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  │  ┌────────────────────────────────────────────────┐         │           │
│  │  │  Network Features                              │         │           │
│  │  │  • Netfilter/iptables (防火墙)                 │         │           │
│  │  │  • Traffic control (流量控制)                  │         │           │
│  │  │  • IPsec (VPN)                                 │         │           │
│  │  │  • Bridging, routing                           │         │           │
│  │  └────────────────────────────────────────────────┘         │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           IPC (Inter-Process Communication)                  │           │
│  │           进程间通信                                         │           │
│  │  • Pipes & FIFOs (管道)                                      │           │
│  │  • Signals (信号)                                            │           │
│  │  • Message queues (消息队列)                                 │           │
│  │  • Semaphores (信号量)                                       │           │
│  │  • Shared memory (共享内存)                                  │           │
│  │  • Unix domain sockets (本地套接字)                          │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           Other Core Services 其他核心服务                   │           │
│  │  • Timer management (定时器管理)                             │           │
│  │  • Interrupt handling (中断处理)                             │           │
│  │  • DMA management (直接内存访问)                             │           │
│  │  • Power management (电源管理)                               │           │
│  │  • Security modules (SELinux, AppArmor)                      │           │
│  │  • Audit subsystem (审计子系统)                              │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DEVICE DRIVERS & MODULES                                 │
│                       设备驱动和内核模块层                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           Block Device Drivers 块设备驱动                    │           │
│  │  • SATA/AHCI drivers (硬盘驱动)                              │           │
│  │  • NVMe drivers (NVMe SSD 驱动)                              │           │
│  │  • SCSI drivers                                              │           │
│  │  • MD/DM (RAID, LVM)                                         │           │
│  │  • Loop device (回环设备)                                    │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           Network Device Drivers 网络设备驱动                │           │
│  │  • Ethernet drivers (以太网卡驱动)                           │           │
│  │    - e1000e (Intel)                                          │           │
│  │    - igb, ixgbe (10G Intel)                                  │           │
│  │    - r8169 (Realtek)                                         │           │
│  │  • Wireless drivers (无线网卡驱动)                           │           │
│  │    - ath9k, ath10k (Atheros)                                 │           │
│  │    - iwlwifi (Intel)                                         │           │
│  │  • Virtual network devices                                   │           │
│  │    - tun/tap, veth, bridge                                   │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           Character Device Drivers 字符设备驱动              │           │
│  │  • TTY/Serial drivers (终端/串口驱动)                        │           │
│  │  • Input drivers (键盘、鼠标)                                │           │
│  │  • RTC (实时时钟)                                            │           │
│  │  • Random/urandom (随机数生成器)                             │           │
│  │  • Sound drivers (声卡驱动 - ALSA)                          │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           Graphics Drivers 图形驱动                          │           │
│  │  • DRM (Direct Rendering Manager)                            │           │
│  │  • i915 (Intel integrated graphics)                          │           │
│  │  • amdgpu (AMD graphics)                                     │           │
│  │  • nouveau (Nvidia open-source)                              │           │
│  │  • nvidia (Nvidia proprietary)                               │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           USB Drivers USB 驱动                               │           │
│  │  • USB core (USB 核心子系统)                                 │           │
│  │  • USB HCI drivers (主机控制器驱动)                          │           │
│  │    - ehci (USB 2.0)                                          │           │
│  │    - xhci (USB 3.0+)                                         │           │
│  │  • USB device drivers (USB 设备驱动)                         │           │
│  │    - usb-storage (USB 存储)                                  │           │
│  │    - usbhid (USB HID 设备)                                   │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           Other Drivers 其他驱动                             │           │
│  │  • PCI/PCIe bus drivers                                      │           │
│  │  • I2C/SPI bus drivers                                       │           │
│  │  • Sensor drivers (温度、风扇等)                             │           │
│  │  • Power supply drivers                                      │           │
│  │  • Platform-specific drivers                                 │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │           Kernel Modules 内核模块                            │           │
│  │  • Loadable kernel modules (.ko files)                       │           │
│  │  • Dynamic loading/unloading (lsmod, modprobe, rmmod)        │           │
│  │  • Module parameters                                         │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                        通过硬件抽象层与物理硬件交互
                                    │
═══════════════════════════════════════════════════════════════════════════════
                          HARDWARE INTERFACE
                            硬件接口层
═══════════════════════════════════════════════════════════════════════════════
                                    │
                    通过寄存器、I/O 端口、中断、DMA 等
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PHYSICAL HARDWARE                                   │
│                            物理硬件层                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │     CPU     │  │   Memory    │  │    Disk     │  │     NIC     │      │
│  │             │  │             │  │             │  │             │      │
│  │ • Cores     │  │ • RAM       │  │ • HDD       │  │ • Ethernet  │      │
│  │ • Caches    │  │ • DDR4/5    │  │ • SSD       │  │ • WiFi      │      │
│  │ • Registers │  │ • Dual      │  │ • NVMe      │  │ • 1G/10G    │      │
│  │ • MMU       │  │   channel   │  │             │  │ • 25G/100G  │      │
│  │ • FPU       │  │             │  │             │  │             │      │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘      │
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │     GPU     │  │     USB     │  │   Display   │  │   Other     │      │
│  │             │  │             │  │             │  │             │      │
│  │ • Compute   │  │ • USB 2.0   │  │ • Monitor   │  │ • Keyboard  │      │
│  │ • Rendering │  │ • USB 3.0+  │  │ • HDMI/DP   │  │ • Mouse     │      │
│  │ • VRAM      │  │ • Type-C    │  │             │  │ • Sensors   │      │
│  │             │  │             │  │             │  │ • RTC       │      │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │                    Motherboard / Chipset                    │           │
│  │  • PCI/PCIe bus                                             │           │
│  │  • SATA controllers                                         │           │
│  │  • USB controllers                                          │           │
│  │  • Interrupt controllers (APIC)                             │           │
│  │  • DMA controllers                                          │           │
│  │  • BIOS/UEFI firmware                                       │           │
│  └─────────────────────────────────────────────────────────────┘           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                          关键概念补充说明
═══════════════════════════════════════════════════════════════════════════════

1. Protection Rings (保护环)
   ┌──────────────────────────────────────┐
   │         Ring 0 (Kernel Mode)         │  ← 最高权限
   │    可以执行特权指令、访问所有硬件     │
   │         ┌────────────────┐           │
   │         │  Ring 1, 2     │           │  ← 很少使用
   │         │  (Hypervisor)  │           │
   │         │  ┌──────────┐  │           │
   │         │  │  Ring 3  │  │           │  ← 用户模式
   │         │  │ (User)   │  │           │     受限权限
   │         │  └──────────┘  │           │
   │         └────────────────┘           │
   └──────────────────────────────────────┘

2. Virtual Memory (虚拟内存)
   
   Process A           Process B           Kernel
   ┌──────────┐       ┌──────────┐       ┌──────────┐
   │ Virtual  │       │ Virtual  │       │ Virtual  │
   │ Address  │       │ Address  │       │ Address  │
   │  Space   │       │  Space   │       │  Space   │
   └────┬─────┘       └────┬─────┘       └────┬─────┘
        │                  │                   │
        └──────────────────┴───────────────────┘
                           │
                    ┌──────▼──────┐
                    │     MMU     │  ← Memory Management Unit
                    │  (Page      │     (硬件支持)
                    │   Tables)   │
                    └──────┬──────┘
                           │
                    ┌──────▼──────────────────────┐
                    │    Physical RAM             │
                    │  ┌────┬────┬────┬────┐     │
                    │  │Page│Page│Page│Page│ ... │
                    │  └────┴────┴────┴────┘     │
                    └─────────────────────────────┘

3. Context Switch (上下文切换)

   User Mode (Ring 3)
        │
        │ 1. 系统调用 (syscall 指令)
        │    或中断、异常
        ▼
   ┌─────────────────────────────┐
   │  Save user context:         │
   │  • 保存寄存器               │
   │  • 保存程序计数器           │
   │  • 保存栈指针               │
   └─────────────┬───────────────┘
                 │
   Kernel Mode (Ring 0)
        │
        │ 2. 切换到内核栈
        │ 3. 切换页表
        │ 4. 执行内核代码
        │ 5. 处理系统调用/中断
        ▼
   ┌─────────────────────────────┐
   │  Restore user context:      │
   │  • 恢复寄存器               │
   │  • 恢复程序计数器           │
   │  • 恢复栈指针               │
   └─────────────┬───────────────┘
                 │
                 │ 6. 返回用户空间 (sysret 指令)
                 ▼
   User Mode (Ring 3)

   开销：约 50-200 纳秒（取决于 CPU）

4. System Call Flow (系统调用流程) - 详细示例

   C 程序: printf("Hello\n");
        │
        ▼
   glibc: printf() 
        │
        ├─ 格式化字符串
        ├─ 准备缓冲区
        │
        ▼
   glibc: write() wrapper
        │
        ├─ 设置寄存器:
        │   • rax = 1 (sys_write 的系统调用号)
        │   • rdi = 1 (stdout 文件描述符)
        │   • rsi = buffer 地址
        │   • rdx = buffer 长度
        │
        ▼
   User: syscall 指令
        │
        ├─ CPU 自动切换到 Ring 0
        ├─ 跳转到内核入口点
        │
        ▼
   Kernel: 系统调用入口 (entry_SYSCALL_64)
        │
        ├─ 保存用户态寄存器到内核栈
        ├─ 切换到内核页表
        ├─ 检查系统调用号是否有效
        │
        ▼
   Kernel: sys_write() 处理函数
        │
        ├─ 检查文件描述符有效性
        ├─ 检查用户空间指针安全性
        ├─ 查找文件对象
        │
        ▼
   Kernel: VFS 层
        │
        ├─ 调用文件系统的 write 方法
        │
        ▼
   Kernel: 具体文件系统或设备驱动
        │
        ├─ 对于 stdout (TTY):
        │   └─> TTY 驱动
        │       └─> 写入终端缓冲区
        │           └─> 显示到屏幕
        │
        ▼
   Kernel: 系统调用返回
        │
        ├─ 设置返回值 (rax = 写入的字节数)
        ├─ 恢复用户态寄存器
        ├─ 切换回用户页表
        │
        ▼
   User: sysret 指令
        │
        ├─ CPU 自动切换到 Ring 3
        ├─ 返回到 glibc
        │
        ▼
   glibc: 检查返回值
        │
        ├─ 如果出错，设置 errno
        │
        ▼
   User: printf() 返回
        │
        ▼
   继续执行用户代码

5. 不同编程语言的系统调用路径对比

   ┌────────────────────────────────────────────────────────────┐
   │                    C/C++ 路径                              │
   ├────────────────────────────────────────────────────────────┤
   │ Your Code → glibc → SYSCALL → Kernel                      │
   │   (直接)     (包装)   (指令)                               │
   │                                                            │
   │ 优点: 性能好，标准                                          │
   │ 缺点: 动态链接，依赖 glibc 版本                            │
   └────────────────────────────────────────────────────────────┘

   ┌────────────────────────────────────────────────────────────┐
   │                    Python 路径                             │
   ├────────────────────────────────────────────────────────────┤
   │ Your Code → CPython → glibc → SYSCALL → Kernel            │
   │   (Python)   (解释器)  (C库)    (指令)                     │
   │                                                            │
   │ 优点: 开发快速                                              │
   │ 缺点: 性能低，多层间接调用                                  │
   └────────────────────────────────────────────────────────────┘

   ┌────────────────────────────────────────────────────────────┐
   │                    Go 路径 (Pure Go)                       │
   ├────────────────────────────────────────────────────────────┤
   │ Your Code → Go Runtime → SYSCALL → Kernel                 │
   │   (Go)      (内置)        (直接)                           │
   │                                                            │
   │ 优点: 静态链接，部署简单，无 glibc 依赖                     │
   │ 缺点: 二进制较大                                            │
   └────────────────────────────────────────────────────────────┘

   ┌────────────────────────────────────────────────────────────┐
   │                    Go 路径 (with Cgo)                      │
   ├────────────────────────────────────────────────────────────┤
   │ Your Code → Cgo Bridge → glibc → SYSCALL → Kernel         │
   │   (Go)      (桥接)        (C库)   (指令)                   │
   │                                                            │
   │ 优点: 可以调用 C 库                                         │
   │ 缺点: 失去静态链接优势，性能有开销                          │
   └────────────────────────────────────────────────────────────┘

   ┌────────────────────────────────────────────────────────────┐
   │                    Rust 路径                               │
   ├────────────────────────────────────────────────────────────┤
   │ Your Code → libc crate → glibc/musl → SYSCALL → Kernel    │
   │   (Rust)    (Rust包装)    (C库)        (指令)              │
   │                                                            │
   │ 优点: 灵活，可选 musl 静态链接                              │
   │ 缺点: (无明显缺点)                                          │
   └────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
```
